# Windows路由表更新指南

## 简介

Windows操作系统提供了多种方法来查看和更新系统的路由表。路由表决定了网络数据包的流向，合理配置路由表对于网络连接和故障排查至关重要。本指南将介绍如何在Windows系统中查看和更新路由表信息。

## 基本概念

在深入了解路由表更新方法前，先了解一些基本概念：

- **路由表(Routing Table)**: 包含了网络数据包的传递规则，决定了数据包如何从源地址到达目标地址
- **目标网络(Destination)**: 数据包要前往的网络地址
- **子网掩码(Netmask)**: 用于定义目标网络的地址范围
- **网关(Gateway)**: 数据包到达目标网络必须经过的下一个路由器IP地址
- **接口(Interface)**: 数据包离开本地计算机的网络接口
- **跃点数(Metric)**: 路由优先级的度量值，数值越小优先级越高

## 查看当前路由表

### 使用命令行查看路由表

在Windows系统中，可以使用以下命令来查看当前路由表：

```cmd
route print
```

或者使用PowerShell命令：

```powershell
Get-NetRoute
```

这些命令会显示当前系统的完整路由表，包含以下几部分信息：
- 接口列表
- IPv4路由表
- IPv6路由表
- 持久路由

### 路由表示例输出

使用`route print`命令后，您会看到类似如下的输出：

```
===========================================================================
接口列表
  12...00 d8 61 a6 78 9c ......Realtek PCIe GbE Family Controller
   1...........................Software Loopback Interface 1
===========================================================================

IPv4 路由表
===========================================================================
活动路由:
网络目标        网络掩码          网关       接口           跃点数
          0.0.0.0          0.0.0.0      192.168.1.1    192.168.1.100     25
        127.0.0.0        255.0.0.0         在链路上         127.0.0.1    331
        127.0.0.1  255.255.255.255         在链路上         127.0.0.1    331
  127.255.255.255  255.255.255.255         在链路上         127.0.0.1    331
      192.168.1.0    255.255.255.0         在链路上     192.168.1.100    281
    192.168.1.100  255.255.255.255         在链路上     192.168.1.100    281
    192.168.1.255  255.255.255.255         在链路上     192.168.1.100    281
        224.0.0.0        240.0.0.0         在链路上         127.0.0.1    331
        224.0.0.0        240.0.0.0         在链路上     192.168.1.100    281
  255.255.255.255  255.255.255.255         在链路上         127.0.0.1    331
  255.255.255.255  255.255.255.255         在链路上     192.168.1.100    281
===========================================================================
持久路由:
  无
```

## 更新路由表方法

### 1. 使用`route`命令

`route`命令是Windows中最常用的路由表管理工具，提供了添加、删除和修改路由的功能。

#### 添加路由

```cmd
route ADD 目标网络 MASK 子网掩码 网关 [METRIC 跃点数] [IF 接口编号]
```

例如，添加到192.168.2.0/24网络的路由，网关为192.168.1.254：

```cmd
route ADD 192.168.2.0 MASK 255.255.255.0 192.168.1.254
```

添加永久路由（重启后仍然保留）：

```cmd
route ADD 192.168.2.0 MASK 255.255.255.0 192.168.1.254 -p
```

#### 删除路由

```cmd
route DELETE 目标网络 [MASK 子网掩码] [网关] [IF 接口编号]
```

例如，删除到192.168.2.0/24网络的路由：

```cmd
route DELETE 192.168.2.0 MASK 255.255.255.0
```

#### 修改路由

修改路由实际上是先删除再添加，没有直接的修改命令。

### 2. 使用PowerShell命令

Windows PowerShell提供了更现代的网络管理命令集。

#### 添加路由

```powershell
New-NetRoute -DestinationPrefix "192.168.2.0/24" -NextHop "192.168.1.254" -InterfaceIndex 12
```

其中InterfaceIndex可以通过`Get-NetAdapter`命令获取。

#### 删除路由

```powershell
Remove-NetRoute -DestinationPrefix "192.168.2.0/24" -Confirm:$false
```

#### 查看特定路由

```powershell
Get-NetRoute -DestinationPrefix "192.168.2.0/24"
```

### 3. 使用网络连接界面

可以通过图形界面来设置静态路由：

1. 打开"控制面板" > "网络和共享中心"
2. 点击"更改适配器设置"
3. 右键点击需要配置的网络连接，选择"属性"
4. 选择"Internet 协议版本 4 (TCP/IPv4)"，点击"属性"
5. 点击"高级"按钮
6. 在"IP 设置"选项卡中，点击"添加"按钮来添加静态路由

> 注意：通过图形界面添加的路由较为有限，适合简单场景，复杂路由配置建议使用命令行。

## 实际应用场景

### 1. 多网络接口路由配置

当一台计算机连接多个网络（如同时连接公司内网和互联网）时，需要配置合适的路由表确保网络数据流向正确。

例如：计算机有两个网络接口：
- 接口1：连接公司内网 192.168.10.0/24，IP地址为 192.168.10.100
- 接口2：连接互联网，IP地址为 10.0.0.100，网关为 10.0.0.1

配置路由表使内网流量通过接口1，互联网流量通过接口2：

```cmd
# 内网流量
route ADD 192.168.10.0 MASK 255.255.255.0 192.168.10.1 METRIC 1 IF 接口1编号

# 默认路由（互联网流量）
route ADD 0.0.0.0 MASK 0.0.0.0 10.0.0.1 METRIC 10 IF 接口2编号
```

### 2. VPN场景下的路由分流

使用VPN时，可能需要部分流量走VPN，部分流量走本地网络。

例如：
- VPN接口IP：10.8.0.2
- VPN服务器网关：10.8.0.1
- 目标内网：172.16.0.0/16

配置让目标内网流量走VPN，其他流量继续走本地网络：

```cmd
# 添加内网流量通过VPN
route ADD 172.16.0.0 MASK 255.255.0.0 10.8.0.1 METRIC 1
```

## 高级路由表管理

### 路由跟踪和故障排查

当网络连接出现问题时，可以使用以下命令进行故障排查：

```cmd
# 跟踪数据包到目标地址的路径
tracert 8.8.8.8

# 显示到目标地址的路由路径
pathping 8.8.8.8
```

### 查看路由表变化

实时监控路由表变化，可以使用以下PowerShell命令：

```powershell
while($true) {
    cls
    Get-NetRoute | Format-Table -AutoSize
    Start-Sleep -Seconds 5
}
```

### 路由优先级管理

当存在多条到达同一目标的路由时，系统会根据跃点数(Metric)来决定使用哪条路由。跃点数越小，优先级越高。

设置高优先级路由：

```cmd
route ADD 192.168.2.0 MASK 255.255.255.0 192.168.1.254 METRIC 1
```

设置低优先级备份路由：

```cmd
route ADD 192.168.2.0 MASK 255.255.255.0 192.168.1.253 METRIC 100
```

## 最佳实践

1. **定期备份路由表**
   ```cmd
   route print > route_backup.txt
   ```

2. **重启前检查持久路由**
   ```cmd
   route print -p
   ```

3. **创建批处理文件来自动配置路由**
   可以创建.bat文件，包含多条route命令，以便快速应用复杂的路由配置。

4. **为临时测试使用非持久路由**
   进行网络测试时，避免使用-p参数，以确保测试后路由配置不会持续存在。

5. **使用详细日志进行故障排查**
   ```cmd
   route ADD 192.168.2.0 MASK 255.255.255.0 192.168.1.254 -p > route_log.txt 2>&1
   ```

## 常见问题解答

1. **问**: 添加了路由但似乎没有生效怎么办？
   **答**: 检查路由优先级是否正确，确保没有其他优先级更高的路由存在。使用`route print`检查路由是否成功添加。

2. **问**: 可以添加多少条路由？
   **答**: Windows系统对路由条目数没有严格限制，但过多的路由条目可能影响性能。

3. **问**: 如何在批处理文件中等待路由命令完成？
   **答**: 使用`call`或在每条命令后添加`timeout /t 1`等待一秒。

4. **问**: 路由表中"在链路上"的网关是什么意思？
   **答**: 这表示该目标网络可以直接通过指定接口访问，不需要经过其他路由器。

5. **问**: 重启后路由设置丢失？
   **答**: 使用`-p`参数设置永久路由，或将路由命令添加到系统启动脚本中。

## 总结

Windows路由表管理是网络管理和故障排查的重要技能。通过正确配置路由表，可以优化网络流量、提高网络效率、解决网络连接问题。本指南介绍的命令和方法适用于Windows 7/8/10/11及Windows Server系列操作系统。 