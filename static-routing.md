# OpenWrt静态路由配置指南

## 简介

OpenWrt是一款适用于路由器的开源Linux操作系统。配置静态路由可以让您更精确地控制网络流量的路径。本指南将详细介绍如何在OpenWrt系统中配置静态路由。

## 基本概念

在OpenWrt中配置静态路由前，您需要了解以下关键概念：

- **目标网络**：需要到达的目标网络地址（如192.168.2.0/24）
- **网关**：数据包通往目标网络的下一跳地址
- **接口**：数据包从路由器发出的网络接口（如lan、wan）
- **跃点数**：路由优先级的度量值，数值越小优先级越高

## 静态路由参数详解

### 路由参数说明

在配置OpenWrt静态路由时，您需要理解以下关键参数的含义：

1. **目标（Target）**
   - 表示数据包的目的地网络地址
   - 格式为IP地址，如192.168.2.0
   - 特殊值0.0.0.0表示默认路由，匹配所有未明确指定的目标地址
   - 单个主机地址使用/32掩码（如192.168.2.5/32）

2. **网关（Gateway）**
   - 指定到达目标网络必须经过的下一个路由器IP地址
   - 网关必须是直接可达的地址（通常在同一子网内）
   - 如果目标网络直接连接到路由器，可以省略网关设置

3. **跃点数（Metric）**
   - 路由优先级的度量值，用于在有多条到达同一目标网络的路由时决定使用哪一条
   - 数值越小，优先级越高
   - 默认值通常为0
   - 可用于实现路由备份和负载均衡

4. **表（Table）**
   - 指定路由所在的路由表
   - OpenWrt默认使用主路由表（ID 254）
   - 策略路由中可以使用多张路由表，根据不同条件选择不同路由

5. **接口（Interface）**
   - 指定数据包从路由器发出的网络接口
   - 常见接口如lan（内网）、wan（外网）等
   - 自定义接口名称取决于您的网络配置

### 路由决策流程

当一个数据包到达OpenWrt路由器时，路由决策过程如下：

1. 检查数据包的目标IP地址
2. 在路由表中查找匹配的路由条目（最长前缀匹配原则）
3. 如果找到多条匹配路由，选择跃点数最小的路由
4. 根据选定路由的网关和接口信息，转发数据包
5. 如果没有找到匹配路由，使用默认路由（0.0.0.0/0）
6. 如果没有默认路由，丢弃数据包

## 网络架构图示例

### 静态路由典型应用场景

下面是一个典型的使用静态路由的网络架构示例：

```
+----------------+     +------------------+     +------------------+
|                |     |                  |     |                  |
| 内网           |     | OpenWrt路由器    |     | 互联网          |
| 192.168.1.0/24 +-----+ WAN:10.0.0.2     +-----+ (通过ISP)       |
|                |     | LAN:192.168.1.1  |     |                  |
+----------------+     +------+---+-------+     +------------------+
                              |   |
                              |   |
                       +------+   +------+
                       |                 |
          +------------v---+     +-------v--------+
          |                |     |                |
          | 子网A         |     | 子网B          |
          | 192.168.2.0/24|     | 192.168.3.0/24 |
          | 网关:192.168.1.2|   | 网关:192.168.1.3|
          +----------------+     +----------------+
```

### 路由决策流程图

```
+---------------+
| 数据包到达    |
+-------+-------+
        |
        v
+-------+-------+
| 检查目标地址  |
+-------+-------+
        |
        v
+-------+-------+     +----------------+
| 查找匹配路由  +---->+ 最长前缀匹配   |
+-------+-------+     +----------------+
        |
        v
+-------+-------+     +----------------+
| 多条匹配路由? +---->+ 选择最小跃点数 |
+-------+-------+     +----------------+
        | 否
        v
+-------+-------+     +----------------+
| 有默认路由?   +---->+ 使用默认路由   |
+-------+-------+     +----------------+
        | 否
        v
+-------+-------+
| 丢弃数据包    |
+---------------+
```

### 示例场景配置

在上图网络架构中，OpenWrt路由器的静态路由配置如下：

1. **到达子网A（192.168.2.0/24）的路由**：

```
# Web界面配置
接口: lan
目标: 192.168.2.0
网络掩码: 255.255.255.0
网关: 192.168.1.2
跃点数: 0

# 命令行配置
uci add network route
uci set network.@route[-1].interface='lan'
uci set network.@route[-1].target='192.168.2.0'
uci set network.@route[-1].netmask='255.255.255.0'
uci set network.@route[-1].gateway='192.168.1.2'
uci set network.@route[-1].metric='0'
uci commit network
```

2. **到达子网B（192.168.3.0/24）的路由**：

```
# Web界面配置
接口: lan
目标: 192.168.3.0
网络掩码: 255.255.255.0
网关: 192.168.1.3
跃点数: 0

# 命令行配置
uci add network route
uci set network.@route[-1].interface='lan'
uci set network.@route[-1].target='192.168.3.0'
uci set network.@route[-1].netmask='255.255.255.0'
uci set network.@route[-1].gateway='192.168.1.3'
uci set network.@route[-1].metric='0'
uci commit network
```

3. **默认路由（到互联网）**：

```
# Web界面配置
接口: wan
目标: 0.0.0.0
网络掩码: 0.0.0.0
网关: 10.0.0.1 (ISP提供的网关)
跃点数: 0

# 命令行配置
uci add network route
uci set network.@route[-1].interface='wan'
uci set network.@route[-1].target='0.0.0.0'
uci set network.@route[-1].netmask='0.0.0.0'
uci set network.@route[-1].gateway='10.0.0.1'
uci set network.@route[-1].metric='0'
uci commit network
```

## 实际OpenWrt界面配置示例

在OpenWrt的Web界面中，静态路由配置通常如下图所示（以文本形式表示）：

```
静态 IPv4 路由
----------------------------------------------------
接口     目标             网关          跃点数     表      禁用
----------------------------------------------------
lan      172.16.0.0/10    192.168.10.1    自动      自动    □
```

### 此配置的流量走向分析

上述配置表示：
- **接口**：lan（本地局域网接口）
- **目标**：172.16.0.0/10（目标网络地址及掩码，覆盖172.16.0.0到172.31.255.255）
- **网关**：192.168.10.1（下一跳地址）
- **跃点数**：自动（系统默认设置）
- **表**：自动（使用默认路由表）

#### 流量走向流程

1. **匹配过程**：
   当数据包到达OpenWrt路由器时，路由器检查该数据包的目标IP地址。如果目标IP落在172.16.0.0到172.31.255.255范围内，则应用此路由规则。

2. **转发决策**：
   - 路由器确认此数据包需要通过网关192.168.10.1转发
   - 使用lan接口发送数据包
   - 系统自动分配跃点数（通常为0）
   - 使用默认路由表

3. **实际流量路径**：

```
源设备 → OpenWrt路由器 → lan接口 → 192.168.10.1(网关) → 172.16.0.0/10网络目标设备
```

4. **应用场景**：
   这种配置常用于企业网络中，特别是当您需要通过不同子网之间的通信时。例如，您的局域网是192.168.10.0/24网段，需要访问位于172.16.0.0/10网段的服务器或设备。

5. **配置命令行等效形式**：

```bash
# 使用UCI命令
uci add network route
uci set network.@route[-1].interface='lan'
uci set network.@route[-1].target='172.16.0.0'
uci set network.@route[-1].netmask='255.240.0.0'
uci set network.@route[-1].gateway='192.168.10.1'
uci commit network
/etc/init.d/network restart
```

## 特殊场景配置

### 旁路由场景下的静态路由配置

旁路由是指将OpenWrt设备作为辅助路由器，不直接连接互联网，而是通过主路由器接入网络的部署方式。在这种拓扑结构下，静态路由配置有一些特殊考虑。

#### 旁路由网络架构

典型的旁路由部署如下：

```
+----------------+     +------------------+     +------------------+
|                |     |                  |     |                  |
| 互联网         |-----+ 主路由器         +-----+ OpenWrt旁路由    |
|                |     | 192.168.80.80    |     | 192.168.80.1     |
+----------------+     +------------------+     +------------------+
                              |
                              |
                     +--------v--------+
                     |                 |
                     | 客户端设备      |
                     | 192.168.80.0/24 |
                     +-----------------+
```

#### 旁路由静态路由配置说明

在旁路由模式下配置静态路由时，需要注意以下几点：

1. **网关设置**：
   - 在旁路由上配置静态路由时，网关应该设置为**主路由器的IP地址**
   - 这是因为所有流量最终都需要通过主路由器转发到目标网络

2. **实际配置示例**：
   以下是在旁路由上配置静态路由的例子（对应截图中的配置）：

```
静态 IPv4 路由
----------------------------------------------------
接口     目标             网关          跃点数     表      禁用
----------------------------------------------------
lan      100.116.0.0/10   192.168.80.80   自动      自动    □
lan      192.168.31.0/24  192.168.80.80   自动      自动    □
lan      192.168.40.0/24  192.168.80.80   自动      自动    □
```

3. **流量走向分析**：
   - 当数据包目的地是100.116.0.0/10网段时，将被发送到192.168.80.80（主路由器）
   - 主路由器根据自己的路由表，将数据包转发到对应的下一跳
   - 同理，访问192.168.31.0/24和192.168.40.0/24网段的流量也会经过主路由器转发

4. **命令行配置示例**：

```bash
# 在旁路由上配置静态路由
uci add network route
uci set network.@route[-1].interface='lan'
uci set network.@route[-1].target='100.116.0.0'
uci set network.@route[-1].netmask='255.192.0.0'
uci set network.@route[-1].gateway='192.168.80.80'
uci commit network
/etc/init.d/network restart
```

#### 旁路由场景特别注意事项

1. **防止路由环路**：
   - 确保主路由器不会将流量错误地路由回旁路由
   - 检查主路由器的路由表，确保没有冲突的路由条目

2. **默认网关设置**：
   - 在旁路由上，默认网关通常应设置为主路由器的IP
   - 这确保了无法匹配其他路由规则的流量能够正确转发

3. **DNS设置**：
   - 如果旁路由也提供DNS服务，需要确保客户端的DNS设置正确
   - 可以通过DHCP服务器配置或手动设置

4. **访问控制**：
   - 在旁路由上配置防火墙规则，确保允许转发必要的流量
   - 检查主路由器的防火墙设置，确保允许旁路由的转发请求

## 配置方法

OpenWrt提供了两种配置静态路由的方法：Web界面(LuCI)和命令行。

### 方法一：通过Web界面(LuCI)配置

1. **登录OpenWrt Web界面**:
   - 在浏览器中输入路由器IP地址（默认通常是192.168.1.1）
   - 输入用户名和密码登录

2. **进入静态路由配置页面**:
   - 点击顶部菜单中的【网络】
   - 选择【路由】选项卡
   - 点击【静态路由】部分

3. **添加新的静态路由**:
   - 点击【添加】按钮
   - 填写以下信息：
     * 接口：选择路由使用的网络接口（如lan、wan）
     * 目标：输入目标网络地址（如192.168.2.0）
     * 网络掩码：输入子网掩码（如255.255.255.0或/24格式）
     * 网关：输入下一跳地址（如192.168.1.254）
     * 跃点数：输入路由优先级（通常为0）
     * MTU：可选，最大传输单元
   - 点击【保存】
   - 点击【保存&应用】使配置生效

### 方法二：通过命令行配置

1. **SSH连接到OpenWrt路由器**:
   ```bash
   ssh root@192.168.1.1
   ```

2. **使用UCI命令添加静态路由**:
   ```bash
   # 添加静态路由
   uci add network route
   uci set network.@route[-1].interface='lan'
   uci set network.@route[-1].target='192.168.2.0'
   uci set network.@route[-1].netmask='255.255.255.0'
   uci set network.@route[-1].gateway='192.168.1.254'
   uci set network.@route[-1].metric='0'
   uci commit network
   ```

3. **重启网络服务使配置生效**:
   ```bash
   /etc/init.d/network restart
   ```

4. **直接编辑配置文件（高级方法）**:
   ```bash
   # 编辑配置文件
   vi /etc/config/network
   
   # 添加以下内容
   config route
       option interface 'lan'
       option target '192.168.2.0'
       option netmask '255.255.255.0'
       option gateway '192.168.1.254'
       option metric '0'
   
   # 保存文件后重启网络服务
   /etc/init.d/network restart
   ```

### 验证配置

配置完成后，可以通过以下方法验证静态路由是否生效：

1. **Web界面验证**:
   - 在LuCI界面中，进入【状态】->【路由表】查看

2. **命令行验证**:
   ```bash
   # 查看路由表
   route -n
   
   # 或使用更现代的ip命令
   ip route show
   ```

3. **测试连通性**:
   ```bash
   # 尝试ping目标网络中的一个IP
   ping 192.168.2.1
   
   # 使用traceroute查看数据包路径
   traceroute 192.168.2.1
   ```

## 配置示例

### 示例1：添加到子网的路由

```
# Web界面配置
接口: lan
目标: 192.168.2.0
网络掩码: 255.255.255.0
网关: 192.168.1.254
跃点数: 0

# 命令行配置
uci add network route
uci set network.@route[-1].interface='lan'
uci set network.@route[-1].target='192.168.2.0'
uci set network.@route[-1].netmask='255.255.255.0'
uci set network.@route[-1].gateway='192.168.1.254'
uci set network.@route[-1].metric='0'
uci commit network
/etc/init.d/network restart
```

### 示例2：添加默认路由

```
# Web界面配置
接口: wan
目标: 0.0.0.0
网络掩码: 0.0.0.0
网关: 192.168.100.1
跃点数: 0

# 命令行配置
uci add network route
uci set network.@route[-1].interface='wan'
uci set network.@route[-1].target='0.0.0.0'
uci set network.@route[-1].netmask='0.0.0.0'
uci set network.@route[-1].gateway='192.168.100.1'
uci set network.@route[-1].metric='0'
uci commit network
/etc/init.d/network restart
```

## 常见问题和故障排除

如果静态路由配置不工作，可以检查以下几点：

1. **确认网关可达**：
   ```bash
   ping 192.168.1.254
   ```

2. **检查路由表是否正确**：
   ```bash
   route -n
   ```

3. **检查防火墙设置**：确保防火墙规则允许目标网络的流量通过
   ```bash
   # 检查防火墙区域设置
   uci show firewall
   ```

4. **检查接口状态**：
   ```bash
   ifconfig
   ```

5. **日志检查**：
   ```bash
   logread | grep network
   ```

## 高级配置

### 基于策略的路由

在复杂网络环境中，您可能需要根据源IP、目标IP或其他条件设置不同的路由路径。OpenWrt支持通过ip rule和ip route结合实现策略路由：

```bash
# 创建一个新的路由表
echo "200 custom" >> /etc/iproute2/rt_tables

# 添加路由规则
ip rule add from 192.168.1.100 table custom
ip route add default via 192.168.1.254 table custom

# 使配置永久生效（添加到启动脚本）
echo "ip rule add from 192.168.1.100 table custom" >> /etc/rc.local
echo "ip route add default via 192.168.1.254 table custom" >> /etc/rc.local
```

## 总结

OpenWrt提供了灵活而强大的静态路由配置方法，通过Web界面或命令行都可以轻松实现。对于简单网络，使用Web界面配置更加直观；而对于复杂网络或需要批量配置的场景，命令行和脚本方式更加高效。

掌握OpenWrt的静态路由配置，可以让您更好地控制网络流量路径，解决网络访问问题，优化网络性能。 