# 网络路由故障排查指南

## 问题概述

在复杂网络环境中，特别是使用主路由+旁路由+Tailscale等多种网络连接方式时，路由冲突是常见问题。本指南记录了一次典型的路由故障排查过程，从发现问题到最终解决，帮助用户理解和解决类似的网络路由问题。

## 网络环境

- **主路由**: IP 10.0.0.1
- **旁路由**: IP 10.0.1.1 (运行iStoreOS/OpenWrt)
- **目标网络**: 10.0.2.0/24
- **网络连接**: Tailscale VPN

## 故障现象

无法从本地网络ping通或访问10.0.2.0/24网段的设备。使用`traceroute`命令测试发现数据包无法正确路由：

```bash
traceroute 10.0.2.1
traceroute to 10.0.2.1 (10.0.2.1), 64 hops max, 40 byte packets
 1  * * *
 2  * *traceroute: sendto: No route to host
...
```

## 故障排查步骤

### 1. 确认静态路由配置

首先检查旁路由上的静态路由配置，发现已配置到10.0.2.0/24的静态路由：

```
目标: 10.0.2.0
掩码: 255.255.255.0
网关: 10.0.1.1
接口: lan
```

这里发现了第一个问题：路由规则将目标网络的下一跳设置为旁路由自己的IP(10.0.1.1)，这会导致路由循环。

### 2. 检查网络连通性

验证到网关的连通性：

```bash
ping -c 4 10.0.1.1
```

结果显示可以ping通10.0.1.1，确认本地网络连通性正常。

### 3. 深入检查旁路由配置

SSH连接到旁路由，检查详细配置：

```bash
ssh root@10.0.1.1 "ip route show; cat /proc/sys/net/ipv4/ip_forward; iptables -L"
```

检查结果发现多个问题：

#### 3.1 路由循环问题

旁路由的路由表中存在循环设置：

```
10.0.2.0/24 via 10.0.1.1 dev br-lan proto static 
10.0.2.0/24 via 172.16.1.24 dev zt6ntli4oj proto static metric 5000 
```

第一条路由将10.0.2.0/24的流量转发给自己(10.0.1.1)，造成路由循环。

#### 3.2 子网掩码过大

旁路由LAN接口使用了过大的子网掩码：

```
10.0.0.0/16 dev br-lan proto kernel scope link src 10.0.1.1
```

这意味着旁路由会将整个10.0.0.0-10.0.255.255范围视为直连网络，包括我们需要通过Tailscale路由的10.0.2.0/24网段。

### 4. 确认IP转发已启用

验证旁路由上的IP转发功能已启用：

```bash
cat /proc/sys/net/ipv4/ip_forward
```

输出"1"，表示IP转发功能已正确启用。

### 5. 检查防火墙设置

确认防火墙未阻止转发流量：

```bash
iptables -L FORWARD
```

确认转发链(FORWARD)策略为接受(ACCEPT)，且未有明显规则阻止转发。

## 解决方案

根据排查结果，需要进行以下修改：

### 1. 修复路由循环问题

删除造成循环的路由条目：

```bash
ip route del 10.0.2.0/24 via 10.0.1.1 dev br-lan
```

在iStoreOS界面中，可以在"网络" > "路由"页面找到并删除有问题的路由条目。

### 2. 调整子网掩码

将旁路由LAN接口的子网掩码从/16(255.255.0.0)缩小到/18(255.255.192.0)，确保10.0.2.0/24不被视为直连网络：

1. 在iStoreOS中，访问"网络" > "接口" > "LAN"
2. 修改IPv4子网掩码为255.255.192.0
3. 保存并应用更改

这样修改后，旁路由只会将10.0.0.0-10.0.63.255视为直连网络，而10.0.2.0/24将通过路由表转发。

### 3. 添加正确的静态路由

如果需要通过Tailscale访问10.0.2.0/24网段，添加正确的静态路由：

1. 在"静态路由"页面添加新路由
2. 设置目标为10.0.2.0，掩码为255.255.255.0
3. 设置网关为Tailscale网络中能访问该网段的节点IP
4. 设置接口为Tailscale接口
5. 设置优先级(跃点数)为较低值，确保优先使用此路由

### 4. 更新主路由配置

确保主路由(10.0.0.1)也配置了正确的静态路由，将发往10.0.2.0/24的流量转发到旁路由：

1. 登录主路由管理界面
2. 添加静态路由：目标10.0.2.0/24，网关10.0.1.1

## 验证解决方案

完成上述配置后，再次测试连通性：

```bash
ping -c 4 10.0.2.1
```

如果一切正常，应能成功ping通10.0.2.1，表示路由问题已解决。

## 故障排查工具

在排查过程中，以下工具非常有用：

1. **ping**: 测试基本连通性
2. **traceroute**: 显示数据包经过的路径
3. **ip route**: 查看和管理路由表
4. **iptables**: 检查防火墙规则
5. **ssh**: 远程登录设备进行配置

## 常见问题及解决方法

### 1. 路由循环

**症状**: 数据包在某个设备上循环，无法到达目的地
**解决**: 检查路由表中是否有将流量路由回设备自身的条目，删除此类条目

### 2. 子网掩码冲突

**症状**: 某些IP地址无法正确路由
**解决**: 调整接口或路由的子网掩码，确保特定网段通过正确的路由转发而不是作为直连网络处理

### 3. 优先级问题

**症状**: 网络可达但走错误的路径
**解决**: 调整静态路由的优先级(跃点数)，确保首选路径具有更高优先级

### 4. IP转发未启用

**症状**: 路由器收到数据包但不转发
**解决**: 确保`/proc/sys/net/ipv4/ip_forward`设置为"1"

### 5. 防火墙阻止

**症状**: 路由配置正确但流量被阻止
**解决**: 检查并调整防火墙规则，确保允许所需的流量转发

## 结论

网络路由问题通常源于配置错误，如路由循环、掩码设置不当或优先级冲突。通过系统性的排查和正确的配置调整，大多数路由问题都能得到解决。

最关键的是要理解路由决策的基本原理，特别是在使用主路由、旁路由和VPN等复杂网络拓扑结构时。掌握这些知识将大大提高网络故障排查的效率。 